# ユーザー管理システム - 要件定義（EAVモデル）

## 📋 概要

**EAV（Entity-Attribute-Value）モデル**を使った柔軟なユーザー管理システムです。

会社の実務で使われているような、動的に属性を追加できる設計を学習します。

### なぜEAVモデルを使うのか？

従来の固定カラム方式では、新しい属性を追加するたびにデータベーススキーマ変更（マイグレーション）が必要です。
EAVモデルを使えば、コードを変更せずに**管理画面から属性を追加**できます。

**従来方式（固定カラム）**:

```sql
-- Users テーブル
| Id | Name | Age | Department | PhoneNumber | ... |
```

→ 新しい属性（例: BloodType）を追加するには、ALTER TABLEが必要

**EAV方式**:

```sql
-- Users テーブル
| Id | Name |

-- Attributes テーブル
| Id | AttributeName | DataType |

-- UserAttributeValues テーブル
| UserId | AttributeId | Value |
```

→ Attributesテーブルに新しい行を追加するだけ！

---

## 🎯 機能要件

### 1. ユーザー管理（基本CRUD）

- **一覧表示**: すべてのユーザーを表示
- **詳細表示**: ユーザーの基本情報と全属性値を表示
- **新規作成**: 名前とメールアドレスを登録、属性値も同時入力
- **編集**: ユーザー情報と属性値を更新
- **削除**: ユーザーを削除（関連する属性値も削除）

### 2. 属性管理（動的スキーマ）

- **属性定義の作成**: 新しい属性を定義（例: "年齢", "部署", "役職"）
- **属性一覧**: 定義済みの属性を表示
- **データ型サポート**: Text（文字列）、Number（数値）、Date（日付）
- **属性編集**: 属性名やデータ型を変更
- **属性削除**: 属性を削除（使用中の場合は警告）

---

## 📊 データモデル（EAV構造）

### 1. Users（ユーザーエンティティ）

| プロパティ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| Id | int | ○ | 主キー（自動採番） |
| Name | string | ○ | ユーザー名（最大100文字） |
| Email | string | ○ | メールアドレス（ユニーク） |
| CreatedAt | DateTime | ○ | 作成日時 |
| UpdatedAt | DateTime | ○ | 更新日時 |

### 2. Attributes（属性定義）

| プロパティ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| Id | int | ○ | 主キー（自動採番） |
| AttributeName | string | ○ | 属性名（例: "年齢", "部署"） |
| DataType | string | ○ | データ型（Text/Number/Date） |
| DisplayOrder | int | ○ | 表示順序 |
| IsRequired | bool | ○ | 必須フラグ |
| CreatedAt | DateTime | ○ | 作成日時 |

### 3. UserAttributeValues（属性値）

| プロパティ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| Id | int | ○ | 主キー（自動採番） |
| UserId | int | ○ | ユーザーID（外部キー） |
| AttributeId | int | ○ | 属性ID（外部キー） |
| Value | string | ○ | 値（すべて文字列で保存） |
| CreatedAt | DateTime | ○ | 作成日時 |
| UpdatedAt | DateTime | ○ | 更新日時 |

**リレーション**:
- User ←1対多→ UserAttributeValue
- Attribute ←1対多→ UserAttributeValue

---

## 🎨 画面設計

### 1. ユーザー一覧画面 (`/UserManagement/User/Index`)

```
+----------------------------------------------------------+
| 👥 ユーザー一覧                         [新規ユーザー作成] |
+----------------------------------------------------------+
| ID | 名前        | メールアドレス         | 操作         |
|----|------------|----------------------|--------------|
| 1  | 青木拓馬    | aoki@example.com     | [詳細][編集][削除] |
| 2  | 山田太郎    | yamada@example.com   | [詳細][編集][削除] |
+----------------------------------------------------------+
```

### 2. ユーザー詳細画面 (`/UserManagement/User/Details/{id}`)

```
+----------------------------------------------------------+
| 👤 ユーザー詳細                        [編集] [削除] [戻る] |
+----------------------------------------------------------+
| 基本情報:
| 名前: 青木拓馬
| メールアドレス: aoki@example.com
| 作成日: 2025/11/08 10:00
|
| 属性情報:
| 年齢: 25
| 部署: 開発部
| 役職: エンジニア
| 入社日: 2023/04/01
+----------------------------------------------------------+
```

### 3. ユーザー編集画面 (`/UserManagement/User/Edit/{id}`)

```
+----------------------------------------------------------+
| ✏️ ユーザー編集                                            |
+----------------------------------------------------------+
| 基本情報:
| 名前*:         [青木拓馬                    ]
| メール*:       [aoki@example.com           ]
|
| 属性情報:
| 年齢 (数値):   [25                         ]
| 部署 (文字):   [開発部                      ]
| 役職 (文字):   [エンジニア                   ]
| 入社日 (日付): [2023-04-01                 ]
|
|                               [保存] [キャンセル]
+----------------------------------------------------------+
```

### 4. 属性管理画面 (`/UserManagement/Attribute/Index`)

```
+----------------------------------------------------------+
| 🏷️ 属性管理                               [新規属性追加] |
+----------------------------------------------------------+
| ID | 属性名  | データ型 | 必須 | 表示順 | 操作      |
|----|--------|---------|------|--------|-----------|
| 1  | 年齢    | Number  | ○   | 1      | [編集][削除] |
| 2  | 部署    | Text    | ○   | 2      | [編集][削除] |
| 3  | 役職    | Text    | -   | 3      | [編集][削除] |
| 4  | 入社日  | Date    | ○   | 4      | [編集][削除] |
+----------------------------------------------------------+
```

---

## 🔧 技術要件

### 使用技術スタック
- ASP.NET Core MVC (net9.0)
- Entity Framework Core 9.x
- SQLite（ファイルベースDB）
- Razor Views（従来型MVC、Ajaxなし）
- Data Annotations（検証）

### 非機能要件
- すべてのDB操作は非同期（async/await）
- CSRF対策（ValidateAntiForgeryToken）
- 参照整合性の保持（外部キー制約）

---

## 🔐 バリデーションルール

### User
- **Name**: 必須、最大100文字
- **Email**: 必須、Email形式、ユニーク制約

### Attribute
- **AttributeName**: 必須、最大50文字
- **DataType**: 必須、"Text", "Number", "Date" のいずれか
- **DisplayOrder**: 必須、1以上の整数

### UserAttributeValue
- **Value**: 必須、最大500文字
- **データ型検証**: Attribute.DataTypeに応じて検証
  - Number型: 数値のみ許可
  - Date型: 日付形式のみ許可

---

## 🎓 学習目標

このシステム実装を通じて、以下のスキルを習得します：

1. **EAVモデルの理解**
   - 動的スキーマ設計の考え方
   - メリット・デメリットの理解
   - 実務での使いどころ

2. **複雑なリレーション**
   - 1対多の関係（User → UserAttributeValue）
   - ナビゲーションプロパティ
   - Include/ThenInclude によるEager Loading

3. **動的UI生成**
   - 属性定義に基づくフォーム生成
   - データ型に応じたバリデーション
   - 柔軟なビューモデル設計

4. **EF Coreの高度な機能**
   - 複合クエリ
   - トランザクション管理
   - カスケード削除

---

次のステップ: `er-diagram.md`でEAVモデルのデータベース設計を確認してください。
